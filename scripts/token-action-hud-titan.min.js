const e=await import("../../token-action-hud-core/scripts/token-action-hud-core.min.js"),t=e.ActionHandler,i=e.ActionListExtender,s=e.CategoryManager,a=e.PreRollHandler,o=e.RollHandler,n=e.SystemManager,r=e.Utils,c=e.Logger,l="token-action-hud-titan";function getSetting(e,t=null){let i=t??null;try{i=game.settings.get(l,e)}catch{c.debug(`Setting '${e}' not found`)}return i}async function setSetting(e,t){game.settings.settings.get(`${l}.${e}`)?(t=await game.settings.set(l,e,t),c.debug(`Setting '${e}' set to '${t}'`)):c.debug(`Setting '${e}' not found`)}function localize(e){return game.i18n.localize(`tokenActionHud.titan.${e}.label`)}class ActionHandler extends t{async buildSystemActions(e,t){const i=e?.actor;if(i){const s=e?.actor?.id,a=e?.token?.id;return await this._buildSingleCharacterActions(s,a,i,t)}return await this._buildMultiCharacterActions()}async _buildSingleCharacterActions(e,t,i){await this._buildAttributesSubcategory(e,t),await this._buildResistancesSubcategory(e,t),await this._buildSkillsSubcategory(e,t),await this._buildWeaponsCategory(e,t,i),await this._buildEquipmentSubcategory(e,t,i),await this._buildAbilitiesCategory(e,t,i),await this._buildSpellsCategory(e,t,i),await this._buildRecoverySubcategory(e,t),await this._buildResourcesSubcategory(e,t,i),await this._buildEffectsSubcategory(e,t,i)}async _buildMultiCharacterActions(){const e="multi",t="multi";await this._buildAttributesSubcategory(e,t),await this._buildResistancesSubcategory(e,t),await this._buildSkillsSubcategory(e,t),await this._buildRecoverySubcategory(e,t),await this._buildResourcesSubcategory(e,t),await this._buildEffectsSubcategory(e,t)}async _buildAttributesSubcategory(e,t){const i=["body","mind","soul"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"attributeCheck",i].join(this.delimiter)})));await this.addActionsToActionList(i,{id:"attributes",type:"system"})}async _buildSkillsSubcategory(e,t){const i=["arcana","athletics","deception","dexterity","diplomacy","engineering","intimidation","investigation","lore","medicine","meleeWeapons","metaphysics","nature","perception","performance","rangedWeapons","subterfuge","stealth"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"skillCheck",i].join(this.delimiter)})));return await this.addActionsToActionList(i,{id:"skills",type:"system"})}async _buildResistancesSubcategory(e,t){const i=["reflexes","resilience","willpower"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"resistanceCheck",i].join(this.delimiter)})));return await this.addActionsToActionList(i,{id:"resistances",type:"system"})}async _buildWeaponsCategory(e,t,i){const s=i.items.filter((e=>"weapon"===e.type&&(e.system.attack.length>0||e.system.check.length>0)&&(getSetting("showUnEquippedEquipment")||e.system.equipped))).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=Math.min(s.length,getSetting("maxWeapons"));for(let i=0;i<a;i++){const a=s[i];await this._buildWeaponSubcategory(e,t,a,i)}}async _buildWeaponSubcategory(e,t,i,s){const a=i._id,o=i.system.attack.map(((i,s)=>({id:`${a}|attack,${s}`,name:i.label,encodedValue:[e,t,"attackCheck",a,s].join(this.delimiter),icon1:"melee"===i.type?'<i class="fas fa-sword"></i>':'<i class="fas fa-bow-arrow"></i>'}))),n=i.system.check.map(((i,s)=>({id:`${a}|itemCheck,${s}`,name:i.label,encodedValue:[e,t,"itemCheck",a,s].join(this.delimiter),icon1:'<i class="fas fa-dice"></i>'}))),r={id:`${a}|toggleMultiAttack`,name:localize(i.system.multiAttack?"multiAttackOn":"multiAttackOff"),encodedValue:[e,t,"toggleMultiAttack",a].join(this.delimiter),icon1:i.system.multiAttack?'<i class="fas fa-swords"></i>':'<i class="fas fa-sword"></i>'},c=`weapon_${s}`,l=i.name,d=this.getImage(i),u=this.categoryManager.getFlattenedSubcategories({id:c,type:"system"});return u[0].name=l,u[0].img=d,await this.addActionsToActionList([...o,...n,r],{id:c,type:"system"})}async _buildEquipmentSubcategory(e,t,i){const s=i.items.filter((e=>{if(e.system.check.length>0)switch(e.type){case"weapon":case"ability":case"spell":return!1;case"armor":return getSetting("showUnEquippedEquipment")||i.system.equipped.armor===e._id;case"shield":return getSetting("showUnEquippedEquipment")||i.system.equipped.shield===e._id;default:return!(!getSetting("showUnEquippedEquipment")&&void 0!==e.system.equipped)||e.system.equipped}})).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=[];return s.forEach((i=>{const s=i._id;i.system.check.forEach(((o,n)=>{a.push({id:`${s}|itemCheck`,name:`${i.name} (${o.label})`,encodedValue:[e,t,"itemCheck",s,n].join(this.delimiter),img:this.getImage(i)})}))})),await this.addActionsToActionList(a,{id:"equipment",type:"system"})}async _buildAbilitiesCategory(e,t,i){const s=i.items.filter((e=>"ability"===e.type&&e.system.check.length>0)).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=[];return s.forEach((i=>{const s=i._id;i.system.check.forEach(((o,n)=>{a.push({id:`${s}|itemCheck`,name:`${i.name} (${o.label})`,encodedValue:[e,t,"itemCheck",s,n].join(this.delimiter),img:this.getImage(i)})}))})),await this.addActionsToActionList(a,{id:"abilities",type:"system"})}async _buildSpellsCategory(e,t,i){const s=i.items.filter((e=>"spell"===e.type)).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=[];s.forEach((e=>{-1===a.indexOf(e.system.tradition)&&a.push(e.system.tradition)}));const o=Math.min(s.length,getSetting("maxSpellTraditions"));for(let i=0;i<o;i++){const o=a[i];await this._buildSpellTraditionSubcategory(e,t,o,s,i)}}async _buildSpellTraditionSubcategory(e,t,i,s,a){const o=s.filter((e=>e.system.tradition===i)),n=[];o.forEach((i=>{const s=i._id;n.push({id:`${s}|castingCheck`,name:`${i.name}`,encodedValue:[e,t,"castingCheck",s].join(this.delimiter),img:this.getImage(i)}),i.system.check.forEach(((a,o)=>{n.push({id:`${s}|itemCheck`,name:`${i.name} (${a.label})`,encodedValue:[e,t,"itemCheck",s,o].join(this.delimiter),img:this.getImage(i)})}))}));const r=`tradition_${a}`,c=i;return this.categoryManager.getFlattenedSubcategories({id:r,type:"system"})[0].name=c,await this.addActionsToActionList(n,{id:r,type:"system"})}async _buildRecoverySubcategory(e,t){const i=[{id:"longRest",name:localize("longRest"),encodedValue:[e,t,"longRest"].join(this.delimiter),icon1:'<i class="fas fa-bed"></i>'},{id:"shortRest",name:localize("shortRest"),encodedValue:[e,t,"shortRest"].join(this.delimiter),icon1:'<i class="fas fa-face-exhaling"></i>'},{id:"removeCombatEffects",name:localize("removeCombatEffects"),encodedValue:[e,t,"removeCombatEffects"].join(this.delimiter),icon1:'<i class="fas fa-arrow-rotate-left"></i>'}];return await this.addActionsToActionList(i,{id:"recovery",type:"system"})}async _buildResourcesSubcategory(e,t,i){const s=[{id:"spendResolve",name:localize("spendResolve"),encodedValue:[e,t,"spendResolve"].join(this.delimiter),icon1:'<i class="fas fa-bolt"></i>'}];return"player"===i?.type&&s.push({id:"toggleInspiration",name:localize("inspiration"),encodedValue:[e,t,"toggleInspiration"].join(this.delimiter),icon1:i.system.inspiration?'<i class="fas fa-sun"></i>':'<i class="far fa-circle"></i>'}),await this.addActionsToActionList(s,{id:"resources",type:"system"})}async _buildEffectsSubcategory(e,t){const i=[{id:"removeExpiredEffects",name:localize("removeExpiredEffects"),encodedValue:[e,t,"removeExpiredEffects"].join(this.delimiter),icon1:'<i class="fas fa-clock"></i>'}];return await this.addActionsToActionList(i,{id:"effects",type:"system"})}}function createDefaults(){const e=getSetting("maxWeapons"),t=getSetting("maxSpellTraditions");return{categories:[{nestId:"attributes",id:"attributes",name:localize("attributes"),subcategories:[{nestId:"attributes_attributes",id:"attributes",name:localize("attributes"),type:"system",hasDerivedSubcategories:!1}]},{nestId:"resistances",id:"resistances",name:localize("resistances"),subcategories:[{nestId:"resistances_resistances",id:"resistances",name:localize("resistances"),type:"system",hasDerivedSubcategories:!1}]},{nestId:"skills",id:"skills",name:localize("skills"),subcategories:[{nestId:"skills_skills",id:"skills",name:localize("skills"),type:"system",hasDerivedSubcategories:!1}]},{nestId:"weapons",id:"weapons",name:localize("weapons"),subcategories:function getWeaponCategories(e){const t=[];for(let i=0;i<e;i++)t.push({nestId:`weapons_weapon_${i}`,id:`weapon_${i}`,name:"",type:"system",hasDerivedSubcategories:!1});return t}(e)},{nestId:"equipment",id:"equipment",name:localize("equipment"),subcategories:[{nestId:"equipment_equipment",id:"equipment",name:localize("equipment"),type:"system",hasDerivedSubcategories:!1}]},{nestId:"abilities",id:"abilities",name:localize("abilities"),subcategories:[{nestId:"abilities_abilities",id:"abilities",name:localize("abilities"),type:"system",hasDerivedSubcategories:!1}]},{nestId:"spells",id:"spells",name:localize("spells"),subcategories:function getSpellTraditionCategories(e){const t=[];for(let i=0;i<e;i++)t.push({nestId:`spells_tradition_${i}`,id:`tradition_${i}`,name:"",type:"system",hasDerivedSubcategories:!1});return t}(t)},{nestId:"utility",id:"utility",name:localize("utility"),subcategories:[{nestId:"utility_recovery",id:"recovery",name:localize("recovery"),type:"system"},{nestId:"utility_resources",id:"resources",name:localize("resources"),type:"system"},{nestId:"utility_effects",id:"effects",name:localize("effects"),type:"system"}]}],subcategories:[{id:"attributes",name:localize("attributes"),type:"system",hasDerivedSubcategories:!1},{id:"skills",name:localize("skills"),type:"system",hasDerivedSubcategories:!1},{id:"resistances",name:localize("resistances"),type:"system",hasDerivedSubcategories:!1},...function getWeaponSubcategories(e){const t=[];for(let i=0;i<e;i++)t.push({id:`weapon_${i}`,name:"",type:"system",hasDerivedSubcategories:!1});return t}(e),{id:"abilities",name:localize("abilities"),type:"system",hasDerivedSubcategories:!1},...function getSpellTraditionSubcategories(e){const t=[];for(let i=0;i<e;i++)t.push({id:`tradition_${i}`,name:"",type:"system",hasDerivedSubcategories:!1});return t}(t),{id:"recovery",name:localize("recovery"),type:"system",hasDerivedSubcategories:!1},{id:"resources",name:localize("resources"),type:"system",hasDerivedSubcategories:!1},{id:"effects",name:localize("effects"),type:"system",hasDerivedSubcategories:!1}]}}class RollHandler extends o{async doHandleActionEvent(e,t){const i=t.split("|");if(i.length<3)return void console.error("TOKEN ACTION HUD (TITAN) | Action Failed. Incomplete Action Data.");const s=i[0],a=i[1],o=i[2];if(i.splice(0,3),"multi"!==a){const e=r.getActor(s,a)?.character;if(e)return await this._performAction(o,i,e)}else for(const e of canvas.tokens.controlled){const t=r.getActor(e.actor?.id,e.id)?.character;t&&await this._performAction(o,i,t)}}async _performAction(e,t,i){switch(e){case"attributeCheck":{const e=t[0];return e?await i.rollAttributeCheck({attribute:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Attribute Check Failed. No provided Attribute.")}case"resistanceCheck":{const e=t[0];return e?await i.rollResistanceCheck({resistance:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Resistance Check Failed. No provided Resistance.")}case"skillCheck":{const e=t[0];return e?await i.rollAttributeCheck({skill:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Skill Check Failed. No provided Skill.")}case"attackCheck":{const e=t[0];if(!e)return console.error("TOKEN ACTION HUD (TITAN) | Attack Check Failed. No provided Weapon ID."),void console.trace();const s=t[1];return s?await i.rollAttackCheck({itemId:e,attackIdx:s},!1):(console.error("TOKEN ACTION HUD (TITAN) | Attack Check Failed. No provided Attack IDX."),void console.trace())}case"toggleMultiAttack":{const e=t[0];return e?await i.toggleMultiAttack(e):(console.error("TOKEN ACTION HUD (TITAN) | Toggle Multi-Attack Failed. No provided Weapon ID."),void console.trace())}case"itemCheck":{const e=t[0];if(!e)return console.error("TOKEN ACTION HUD (TITAN) | Item Check Failed. No provided Item ID."),void console.trace();const s=t[1];return s?await i.rollItemCheck({itemId:e,checkIdx:s},!1):(console.error("TOKEN ACTION HUD (TITAN) | Item Check Failed. No provided Check IDX."),void console.trace())}case"castingCheck":{const e=t[0];return e?await i.rollCastingCheck({itemId:e},!1):(console.error("TOKEN ACTION HUD (TITAN) | Casting Check Failed. No provided Item ID."),void console.trace())}case"longRest":return await i.longRest(!0);case"shortRest":return await i.shortRest(!0);case"removeCombatEffects":return await i.removeCombatEffects(!0);case"removeExpiredEffects":return await i.removeExpiredEffects(!1);case"spendResolve":return await i.spendResolve(!0);case"toggleInspiration":return await i.toggleInspiration();default:return console.error(`TOKEN ACTION HUD (TITAN) | Action. Invalid action type (${e}).`),void console.trace()}}}function register(e){const t="token-action-hud-titan";game.settings.register(t,"showUnEquippedEquipment",{name:game.i18n.localize("tokenActionHud.titan.settings.showUnEquippedEquipment.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.showUnEquippedEquipment.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"maxWeapons",{name:game.i18n.localize("tokenActionHud.titan.settings.maxWeapons.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.maxWeapons.hint"),scope:"client",config:!0,type:Number,default:5,range:{min:3,max:10,step:1},requiresReload:!0,onChange:t=>{e(t)}}),game.settings.register(t,"maxSpellTraditions",{name:game.i18n.localize("tokenActionHud.titan.settings.maxSpellTraditions.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.maxSpellTraditions.hint"),scope:"client",config:!0,type:Number,default:5,range:{min:3,max:10,step:1},requiresReload:!0,onChange:t=>{e(t)}})}class SystemManager extends n{doGetCategoryManager(){return new s}doGetActionHandler(e){return new ActionHandler(e)}getAvailableRollHandlers(){const e={core:"Core Titan"};return n.addHandler(e),e}doGetRollHandler(e){return new RollHandler}doRegisterSettings(e){register(e)}async doRegisterDefaultFlags(){const e=createDefaults();await r.setUserFlag("default",e),await r.setUserFlag("categories",foundry.utils.deepClone(e.categories)),await r.setUserFlag("subcategories",foundry.utils.deepClone(e.subcategories))}}const d={ID:"token-action-hud-titan"},u="1.1",m={bonus:"fas fa-plus",crew:"fas fa-users",day:"fas fa-hourglass-end",hour:"fas fa-hourglass-half",lair:"fas fa-home",minute:"fas fa-hourglass-start",legendary:"fas fas fa-dragon",reaction:"fas fa-bolt",special:"fas fa-star"},g="fas fa-circle-c",p="fas fa-sun",h="fas fa-circle-r",y={.5:"fas fa-adjust",1:"fas fa-check",2:"fas fa-check-double"};Hooks.once("ready",(async()=>{const e=game.modules.get(d.ID);e.api={requiredCoreModuleVersion:"1.1",SystemManager:SystemManager},Hooks.call("tokenActionHudSystemReady",e)}));export{m as ACTIVATION_TYPE_ICON,g as CONCENTRATION_ICON,t as CoreActionHandler,i as CoreActionListExtender,s as CoreCategoryManager,a as CorePreRollHandler,o as CoreRollHandler,n as CoreSystemManager,r as CoreUtils,c as Logger,d as MODULE,p as PREPARED_ICON,y as PROFICIENCY_LEVEL_ICON,u as REQUIRED_CORE_MODULE_VERSION,h as RITUAL_ICON,RollHandler,SystemManager,createDefaults,getSetting,localize,register,setSetting};
