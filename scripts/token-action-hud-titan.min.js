const e={ID:"token-action-hud-titan"},t={ID:"token-action-hud-core"},i="1.5";function getSetting(t,i=null){let s=i??null;try{s=game.settings.get(e.ID,t)}catch{console.error(`Setting '${t}' not found`)}return s}async function setSetting(t,i){game.settings.settings.get(`${e.ID}.${t}`)?(i=await game.settings.set(e.ID,t,i),console.error(`Setting '${t}' set to '${i}'`)):console.error(`Setting '${t}' not found`)}function localize(e){return game.i18n.localize(`tokenActionHud.titan.${e}.label`)}function getControlledActors(){return Array.from(canvas.tokens.controlled.filter((e=>e.actor)).map((e=>e.actor)))}function getControlledTokens(){return Array.from(canvas.tokens.controlled).filter((e=>e.actor))}let s=null;function createDefaults(){const e=getSetting("maxWeapons"),t=getSetting("maxSpellTraditions"),i=[];for(let t=0;t<e;t++)i.push({nestId:`weapons_weapon${t}`,id:`weapon${t}`,name:"",type:"system"});const s=[];for(let e=0;e<t;e++)s.push({nestId:`spells_tradition${e}`,id:`tradition${e}`,name:"",type:"system"});const a={nestId:"attributes_attributes",id:"attributes",name:localize("attributes"),type:"system"},n={nestId:"attributes_test",id:"test",name:"test",type:"system"},o={nestId:"resistances_resistances",id:"resistances",name:localize("resistances"),type:"system"},l={nestId:"skills_skills",id:"skills",name:localize("skills"),type:"system"},r={nestId:"equipment_equipment",id:"equipment",name:localize("equipment"),type:"system"},c={nestId:"abilities_abilities",id:"abilities",name:localize("abilities"),type:"system"},d={nestId:"utility_recovery",id:"recovery",name:localize("recovery"),type:"system"},u={nestId:"utility_resources",id:"resources",name:localize("resources"),type:"system"},m={nestId:"utility_effects",id:"effects",name:localize("effects"),type:"system"},p=[a,n,o,l,...i,r,c,...s,d,u,m];return{layout:[{nestId:"attributes",id:"attributes",name:localize("attributes"),groups:[a,n]},{nestId:"resistances",id:"resistances",name:localize("resistances"),groups:[o]},{nestId:"skills",id:"skills",name:localize("skills"),groups:[l]},{nestId:"weapons",id:"weapons",name:localize("weapons"),groups:i},{nestId:"equipment",id:"equipment",name:localize("equipment"),groups:[r]},{nestId:"abilities",id:"abilities",name:localize("abilities"),groups:[c]},{nestId:"spells",id:"spells",name:localize("spells"),groups:s},{nestId:"utility",id:"utility",name:localize("utility"),groups:[d,u,m]}],groups:p}}Hooks.once("tokenActionHudCoreApiReady",(async e=>{s=class ActionHandlerClass extends e.api.ActionHandler{_getGroup(e={}){return e?.nestId?this.groups[e.nestId]:Object.values(this.groups).find((t=>!(e.id&&t.id!==e.id||e.type&&t.type!==e.type||e.level&&t.level!==e.level)))}async buildSystemActions(e){if(1===getControlledActors().length){const t=this.actor?.id,i=this.token?.id;return await this._buildSingleCharacterActions(t,i,this.actor,e)}return await this._buildMultiCharacterActions()}async _buildSingleCharacterActions(e,t,i){await this._buildAttributesGroup(e,t),await this._buildResistancesGroup(e,t),await this._buildSkillsGroup(e,t),await this._buildWeaponsCategory(e,t,i),await this._buildEquipmentGroup(e,t,i),await this._buildAbilitiesCategory(e,t,i),await this._buildSpellsCategory(e,t,i),await this._buildRecoveryGroup(e,t),await this._buildResourcesGroup(e,t,i),await this._buildEffectsGroup(e,t,i)}async _buildMultiCharacterActions(){const e="multi",t="multi";await this._buildAttributesGroup(e,t),await this._buildResistancesGroup(e,t),await this._buildSkillsGroup(e,t),await this._buildRecoveryGroup(e,t),await this._buildResourcesGroup(e,t),await this._buildEffectsGroup(e,t)}async _buildAttributesGroup(e,t){const i=["body","mind","soul"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"attributeCheck",i].join(this.delimiter)})));await this.addActions(i,{id:"attributes",type:"system"})}async _buildSkillsGroup(e,t){const i=["arcana","athletics","deception","dexterity","diplomacy","engineering","intimidation","investigation","lore","medicine","meleeWeapons","metaphysics","nature","perception","performance","rangedWeapons","subterfuge","stealth"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"skillCheck",i].join(this.delimiter)})));return await this.addActions(i,{id:"skills",type:"system"})}async _buildResistancesGroup(e,t){const i=["reflexes","resilience","willpower"].map((i=>({id:i,name:localize(i),encodedValue:[e,t,"resistanceCheck",i].join(this.delimiter)})));return await this.addActions(i,{id:"resistances",type:"system"})}async _buildWeaponsCategory(e,t,i){const s=i.items.filter((e=>"weapon"===e.type&&(e.system.attack.length>0||e.system.check.length>0)&&(getSetting("showUnEquippedEquipment")||e.system.equipped))).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=Math.min(s.length,getSetting("maxWeapons"));for(let i=0;i<a;i++){const a=s[i];await this._buildWeaponGroup(e,t,a,i)}}async _buildWeaponGroup(t,i,s,a){const n=s._id,o=s.system.attack.map(((e,s)=>({id:`${n}|attack,${s}`,name:e.label,encodedValue:[t,i,"attackCheck",n,s].join(this.delimiter),icon1:"melee"===e.type?'<i class="fas fa-sword"></i>':'<i class="fas fa-bow-arrow"></i>'}))),l=s.system.check.map(((e,s)=>({id:`${n}|itemCheck,${s}`,name:e.label,encodedValue:[t,i,"itemCheck",n,s].join(this.delimiter),icon1:'<i class="fas fa-dice"></i>'}))),r={id:`${n}|toggleMultiAttack`,name:localize(s.system.multiAttack?"multiAttackOn":"multiAttackOff"),encodedValue:[t,i,"toggleMultiAttack",n].join(this.delimiter),icon1:s.system.multiAttack?'<i class="fas fa-swords"></i>':'<i class="fas fa-sword"></i>'},c={id:`weapon${a}`,type:"system"},d=this._getGroup(c);return d.name=s.name,d.img=e.api.Utils.getImage(s),await this.addActions([...o,...l,r],c)}async _buildEquipmentGroup(t,i,s){const a=s.items.filter((e=>{if(e.system.check.length>0)switch(e.type){case"weapon":case"ability":case"spell":return!1;case"armor":return getSetting("showUnEquippedEquipment")||s.system.equipped.armor===e._id;case"shield":return getSetting("showUnEquippedEquipment")||s.system.equipped.shield===e._id;default:return!(!getSetting("showUnEquippedEquipment")&&void 0!==e.system.equipped)||e.system.equipped}return!1})).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),n=[];return a.forEach((s=>{const a=s._id;s.system.check.forEach(((o,l)=>{n.push({id:`${a}|itemCheck`,name:`${s.name} (${o.label})`,encodedValue:[t,i,"itemCheck",a,l].join(this.delimiter),img:e.api.Utils.getImage(s)})}))})),await this.addActions(n,{id:"equipment",type:"system"})}async _buildAbilitiesCategory(t,i,s){const a=s.items.filter((e=>"ability"===e.type&&e.system.check.length>0)).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),n=[];return a.forEach((s=>{const a=s._id;s.system.check.forEach(((o,l)=>{n.push({id:`${a}|itemCheck`,name:`${s.name} (${o.label})`,encodedValue:[t,i,"itemCheck",a,l].join(this.delimiter),img:e.api.Utils.getImage(s)})}))})),await this.addActions(n,{id:"abilities",type:"system"})}async _buildSpellsCategory(e,t,i){const s=i.items.filter((e=>"spell"===e.type)).sort(((e,t)=>e.sort<t.sort?-1:e.sort>t.sort?1:0)),a=[];s.forEach((e=>{-1===a.indexOf(e.system.tradition)&&a.push(e.system.tradition)}));const n=Math.min(s.length,getSetting("maxSpellTraditions"));for(let i=0;i<n;i++){const n=a[i];await this._buildSpellTraditionGroup(e,t,n,s,i)}}async _buildSpellTraditionGroup(t,i,s,a,n){const o=a.filter((e=>e.system.tradition===s)),l=[];o.forEach((s=>{const a=s._id;l.push({id:`${a}|castingCheck`,name:`${s.name}`,encodedValue:[t,i,"castingCheck",a].join(this.delimiter),img:e.api.Utils.getImage(s)}),s.system.check.forEach(((n,o)=>{l.push({id:`${a}|itemCheck`,name:`${s.name} (${n.label})`,encodedValue:[t,i,"itemCheck",a,o].join(this.delimiter),img:e.api.Utils.getImage(s)})}))}));const r={id:`tradition${n}`,type:"system"};return this._getGroup(r).name=s,await this.addActions(l,r)}async _buildRecoveryGroup(e,t){const i=[{id:"longRest",name:localize("longRest"),encodedValue:[e,t,"longRest"].join(this.delimiter),icon1:'<i class="fas fa-bed"></i>'},{id:"shortRest",name:localize("shortRest"),encodedValue:[e,t,"shortRest"].join(this.delimiter),icon1:'<i class="fas fa-face-exhaling"></i>'},{id:"removeCombatEffects",name:localize("removeCombatEffects"),encodedValue:[e,t,"removeCombatEffects"].join(this.delimiter),icon1:'<i class="fas fa-arrow-rotate-left"></i>'}];return await this.addActions(i,{id:"recovery",type:"system"})}async _buildResourcesGroup(e,t,i){const s=[{id:"spendResolve",name:localize("spendResolve"),encodedValue:[e,t,"spendResolve"].join(this.delimiter),icon1:'<i class="fas fa-bolt"></i>'}];return"player"===i?.type&&s.push({id:"toggleInspiration",name:localize("inspiration"),encodedValue:[e,t,"toggleInspiration"].join(this.delimiter),icon1:i.system.inspiration?'<i class="fas fa-sun"></i>':'<i class="far fa-circle"></i>'}),await this.addActions(s,{id:"resources",type:"system"})}async _buildEffectsGroup(e,t){const i=[{id:"removeExpiredEffects",name:localize("removeExpiredEffects"),encodedValue:[e,t,"removeExpiredEffects"].join(this.delimiter),icon1:'<i class="fas fa-clock"></i>'}];return await this.addActions(i,{id:"effects",type:"system"})}}}));let a=null;function register(t){console.log("Token Action HUD TITAN | Registering settings."),game.settings.register(e.ID,"showUnEquippedEquipment",{name:game.i18n.localize("tokenActionHud.titan.settings.showUnEquippedEquipment.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.showUnEquippedEquipment.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"maxWeapons",{name:game.i18n.localize("tokenActionHud.titan.settings.maxWeapons.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.maxWeapons.hint"),scope:"client",config:!0,type:Number,default:5,range:{min:3,max:10,step:1},requiresReload:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"maxSpellTraditions",{name:game.i18n.localize("tokenActionHud.titan.settings.maxSpellTraditions.label"),hint:game.i18n.localize("tokenActionHud.titan.settings.maxSpellTraditions.hint"),scope:"client",config:!0,type:Number,default:5,range:{min:3,max:10,step:1},requiresReload:!0,onChange:e=>{t(e)}})}Hooks.once("tokenActionHudCoreApiReady",(async e=>{a=class RollHandlerClass extends e.api.RollHandler{async handleActionClick(t,i){const s=i.split("|");if(s.length<3)return void console.error("TOKEN ACTION HUD (TITAN) | Action Failed. Incomplete Action Data.");const a=s[0],n=s[1],o=s[2];if(s.splice(0,3),"multi"!==n){const t=e.api.Utils.getActor(a,n);if(t&&t.system.isCharacter)return await this._performAction(o,s,t)}else for(const t of canvas.tokens.controlled){const i=e.api.Utils.getActor(t.actor?.id,t.id);i&&i.system.isCharacter&&await this._performAction(o,s,i)}}async _performAction(e,t,i){switch(e){case"attributeCheck":{const e=t[0];return e?await i.system.rollAttributeCheck({attribute:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Attribute Check Failed. No provided Attribute.")}case"resistanceCheck":{const e=t[0];return e?await i.system.rollResistanceCheck({resistance:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Resistance Check Failed. No provided Resistance.")}case"skillCheck":{const e=t[0];return e?await i.system.rollAttributeCheck({skill:e},!1):void console.error("TOKEN ACTION HUD (TITAN) | Skill Check Failed. No provided Skill.")}case"attackCheck":{const e=t[0];if(!e)return console.error("TOKEN ACTION HUD (TITAN) | Attack Check Failed. No provided Weapon ID."),void console.trace();const s=t[1];return s?await i.system.rollAttackCheck(e,s,!1):(console.error("TOKEN ACTION HUD (TITAN) | Attack Check Failed. No provided Attack IDX."),void console.trace())}case"toggleMultiAttack":{const e=t[0];return e?await i.toggleMultiAttack(e):(console.error("TOKEN ACTION HUD (TITAN) | Toggle Multi-Attack Failed. No provided Weapon ID."),void console.trace())}case"itemCheck":{const e=t[0];if(!e)return console.error("TOKEN ACTION HUD (TITAN) | Item Check Failed. No provided Item ID."),void console.trace();const s=t[1];return s?await i.rollItemCheck(e,s,!1):(console.error("TOKEN ACTION HUD (TITAN) | Item Check Failed. No provided Check IDX."),void console.trace())}case"castingCheck":{const e=t[0];return e?await i.rollCastingCheck(e,!1):(console.error("TOKEN ACTION HUD (TITAN) | Casting Check Failed. No provided Item ID."),void console.trace())}case"longRest":return await i.longRest(!0);case"shortRest":return await i.shortRest(!0);case"removeCombatEffects":return await i.removeCombatEffects(!0);case"removeExpiredEffects":return await i.removeExpiredEffects(!1);case"spendResolve":return await i.spendResolve(1,1,!0);case"toggleInspiration":return await i.toggleInspiration();default:return console.error(`TOKEN ACTION HUD (TITAN) | Action. Invalid action type (${e}).`),void console.trace()}}}}));let n=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{n=class SystemManagerClass extends e.api.SystemManager{getActionHandler(){return new s}getAvailableRollHandlers(){const t={core:"Core Titan"};return e.api.SystemManager.addHandler(t),t}getRollHandler(){return new a}registerSettings(e){register(e)}async registerDefaults(){return createDefaults()}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{console.log("Token Action HUD TITAN | Initializing.");const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"1.5",SystemManager:n},Hooks.call("tokenActionHudSystemReady",t),console.log("Token Action HUD TITAN | Initialized.")}));export{s as ActionHandler,t as CORE_MODULE,e as MODULE,i as REQUIRED_CORE_MODULE_VERSION,a as RollHandler,n as SystemManager,createDefaults,getControlledActors,getControlledTokens,getSetting,localize,register,setSetting};
