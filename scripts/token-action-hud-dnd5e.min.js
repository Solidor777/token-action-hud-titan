const e=await import("../../token-action-hud-core/scripts/token-action-hud-core.min.js"),t=e.ActionHandler,i=e.ActionListExtender,s=e.CategoryManager,n=e.PreRollHandler,l=e.RollHandler,o=e.SystemManager,a=e.Logger,c="token-action-hud-dnd5e";function getSetting(e,t=null){let i=t??null;try{i=game.settings.get(c,e)}catch{a.debug(`Setting '${e}' not found`)}return i}async function setSetting(e,t){game.settings.settings.get(`${c}.${e}`)?(t=await game.settings.set(c,e,t),a.debug(`Setting '${e}' set to '${t}'`)):a.debug(`Setting '${e}' not found`)}class ActionHandler extends t{async buildSystemActions(e,t,i){const s=t?.actor;return"character"===s?.type||"npc"===s?.type?this._buildCharacterActions(e,t,i):"vehicle"===s?.type?this._buildVehicleActions(e,t,i):s?void 0:this._buildMultipleTokenActions(e,i)}async _buildCharacterActions(e,t,i){const s=i.filter((e=>"equipped"===e||"consumables"===e||"containers"===e||"equipment"===e||"loot"===e||"tools"===e||"weapons"===e||"unequipped"===e)),n=i.filter((e=>"actions"===e||"bonus-actions"===e||"crew-actions"===e||"lair-actions"===e||"legendary-actions"===e||"reactions"===e||"other-actions"===e)),l=i.filter((e=>"passive-effects"===e||"temporary-effects"===e)),o=i.filter((e=>"active-features"===e||"passive-features"===e)),a=i.filter((e=>"cantrips"===e||"1st-level-spells"===e||"2nd-level-spells"===e||"3rd-level-spells"===e||"4th-level-spells"===e||"5th-level-spells"===e||"6th-level-spells"===e||"7th-level-spells"===e||"8th-level-spells"===e||"9th-level-spells"===e));i.some((e=>"abilities"===e))&&this._buildAbilities(e,t,"ability","abilities"),i.some((e=>"checks"===e))&&this._buildAbilities(e,t,"abilityCheck","checks"),n&&this._buildActions(e,t,n),i.some((e=>"combat"===e))&&this._buildCombat(e,t),i.some((e=>"conditions"===e))&&this._buildConditions(e,t),o&&this._buildFeatures(e,t,o),l&&this._buildEffects(e,t,l),s&&this._buildInventory(e,t,s),i.some((e=>"rests"===e))&&this._buildRests(e,t),i.some((e=>"saves"===e))&&this._buildAbilities(e,t,"abilitySave","saves"),i.some((e=>"skills"===e))&&this._buildSkills(e,t),a&&this._buildSpells(e,t,a),i.some((e=>"utility"===e))&&this._buildUtility(e,t)}async _buildVehicleActions(e,t,i){const s=i.filter((e=>"consumables"===e||"equipment"===e||"tools"===e||"weapons"===e)),n=i.filter((e=>"passive-effects"===e||"temporary-effects"===e||"inactive-effects"===e)),l=i.filter((e=>"active-features"===e||"passive-features"===e));i.some((e=>"abilities"===e))&&this._buildAbilities(e,t,"ability","abilities"),i.some((e=>"checks"===e))&&this._buildAbilities(e,t,"abilityCheck","checks"),i.some((e=>"combat"===e))&&this._buildCombat(e,t),i.some((e=>"conditions"===e))&&this._buildConditions(e,t),i.some((e=>"effects"===e))&&this._buildEffects(e,t,n),l&&this._buildFeatures(e,t),s&&this._buildInventory(e,t,s),i.some((e=>"saves"===e))&&this._buildAbilities(e,t,"abilitySave","saves"),i.some((e=>"utility"===e))&&this._buildUtility(e,t)}async _buildMultipleTokenActions(e,t){const i={actor:{id:"multi"},token:{id:"multi"}};t.some((e=>"abilities"===e))&&this._buildAbilities(e,i,"ability","abilities"),t.some((e=>"combat"===e))&&this._buildCombat(e,i),t.some((e=>"conditions"===e))&&this._buildConditions(e,i),t.some((e=>"checks"===e))&&this._buildAbilities(e,i,"abilityCheck","checks"),t.some((e=>"rests"===e))&&this._buildRests(e,i),t.some((e=>"saves"===e))&&this._buildAbilities(e,i,"abilitySave","saves"),t.some((e=>"skills"===e))&&this._buildSkills(e,i),t.some((e=>"utility"===e))&&this._buildUtility(e,i)}_buildAbilities(e,t,i,s){const n=t?.actor,l=t?.actor?.id,o=t.token?.id,a=getSetting("abbreviateSkills"),c="multi"===l?game.dnd5e.config.abilities:n.system.abilities;if(0===c.length)return;const r=Object.entries(c).filter((e=>0!==c[e[0]].value)).map((e=>{const t=e[0],n=t.charAt(0).toUpperCase()+t.slice(1),r=a?n:game.dnd5e.config.abilities[t],d=[i,l,o,t].join(this.delimiter);let m;return m="checks"===s?"":this._getProficiencyIcon(c[t].proficient),{id:t,name:r,encodedValue:d,icon:m,selected:!0}}));this.addActionsToActionList(e,r,s)}_buildActions(e,t,i){const s=t?.actor;if(!s)return;let n=s.items;0!==n.length&&(n=this._discardSlowItems(n),i.forEach((i=>{let s=null;switch(i){case"actions":s="action";break;case"bonus-actions":s="bonus";break;case"crew-actions":s="crew";break;case"lair-actions":s="lair";break;case"legendary-actions":s="legendary";break;case"reactions":s="reaction";break;case"other-actions":s=""}const l=n.filter((e=>e.system?.activation?.type===s));this._buildItems(e,t,l,i)})))}_buildCombat(e,t){const i=t?.actor?.id,s=t?.token?.id,n="utility",l={initiative:{id:"initiative",name:this.i18n("tokenActionHud.dnd5e.rollInitiative")},endTurn:{id:"endTurn",name:this.i18n("tokenActionHud.endTurn")}};game.combat?.current?.tokenId!==s&&delete l.endTurn;const o=Object.entries(l).map((e=>{const t=e[1].id,l=e[1].name,o=[n,i,s,t].join(this.delimiter);let a="",c="";if("initiative"===e[0]&&game.combat){const e=canvas.tokens.controlled.map((e=>e.id)),t=game.combat.combatants.filter((t=>e.includes(t.tokenId)));if(1===t.length){a=t[0].initiative}c=`toggle${t.length>0&&t.every((e=>e?.initiative))?" active":""}`}return{id:t,name:l,encodedValue:o,info1:a,cssClass:c,selected:!0}}));this.addActionsToActionList(e,o,"combat")}_buildConditions(e,t){if(!t?.token)return;const i=t?.actor,s=t?.actor?.id,n=t?.token?.id,l="multi"===s?this._getActors():[i],o="condition",a=CONFIG.statusEffects.filter((e=>""!==e.id));if(0===a.length)return;const c=a.map((e=>{const t=e.id,i=this.i18n(e.label),a=[o,s,n,t].join(this.delimiter),c=l.every((e=>e.effects.map((e=>e.flags?.core?.statusId)).some((e=>e===t))))?" active":"",r=`toggle${c}`,d=e.icon;return{id:t,name:i,encodedValue:a,img:d,cssClass:r,selected:!0}}));this.addActionsToActionList(e,c,"conditions")}_buildEffects(e,t,i){const s=t?.actor,n="effect",l=s.effects;if(0!==l.size){if(i.some((e=>"passive-effects"===e))){const i=l.filter((e=>!e.isTemporary));this._buildItems(e,t,i,"passive-effects",n)}if(i.some((e=>"temporary-effects"===e))){const i=l.filter((e=>e.isTemporary));this._buildItems(e,t,i,"temporary-effects",n)}}}_buildFeatures(e,t,i){const s=t?.actor,n="feature";let l=s.items.filter((e=>"feat"===e.type));if(0!==l.length){if(l=this._discardSlowItems(l),l=this.sortItems(l),i.some((e=>"active-features"===e))){const i=l.filter((e=>{const t=e.system.activation.type;return t&&""!==t&&"lair"!==t&&"legendary"!==t}));this._buildItems(e,t,i,"active-features",n)}if(i.some((e=>"passive-features"===e))){const i=l.filter((e=>{const t=e.system.activation.type;return!t||""===t}));this._buildItems(e,t,i,"passive-features",n)}}}_buildInventory(e,t,i){const s=t?.actor,n=this._discardSlowItems(s.items.filter((e=>e.system.quantity>0)));if(0===n.length)return;const l=this.sortItems(n);if(i.some((e=>"equipped"===e))){const i=this._getActiveEquipment(l.filter((e=>e.system.equipped)));this._buildItems(e,t,i,"equipped")}if(i.some((e=>"unequipped"===e))){const i=this._getActiveEquipment(l.filter((e=>!e.system.equipped)));this._buildItems(e,t,i,"unequipped")}if(i.some((e=>"consumables"===e))){const i=this._getActiveEquipment(l.filter((e=>"consumable"===e.type))),s=this._discardExpendedItems(i);this._buildItems(e,t,s,"consumables")}let o;o=getSetting("showUnequippedItems")?l.filter((e=>"consumable"!==e.type&&"spell"!==e.type&&"feat"!==e.type)):l.filter((e=>"consumable"!==e.type&&e.system.equipped));const a=this._getActiveEquipment(o);if(i.some((e=>"containers"===e))){const i=a.filter((e=>"backpack"===e.type));this._buildItems(e,t,i,"containers")}if(i.some((e=>"equipment"===e))){const i=a.filter((e=>"equipment"===e.type));this._buildItems(e,t,i,"equipment")}if(i.some((e=>"loot"===e))){const i=a.filter((e=>"loot"===e.type));this._buildItems(e,t,i,"loot")}if(i.some((e=>"tools"===e))){const i=n.filter((e=>"tool"===e.type));this._buildItems(e,t,i,"tools")}if(i.some((e=>"weapons"===e))){const i=a.filter((e=>"weapon"===e.type));this._buildItems(e,t,i,"weapons")}}_buildItems(e,t,i,s,n="item"){if(0===i.length)return;const l=i.map((e=>this._getAction(n,t,e)));this.addActionsToActionList(e,l,s)}_getActiveEquipment(e){let t=[];if(getSetting("showItemsWithoutActivationCosts"))t=e;else{const i=Object.keys(game.dnd5e.config.abilityActivationTypes).filter((e=>"none"!==e));t=e.filter((e=>!!e.system.activation&&i.includes(e.system.activation.type)))}return t}_getAction(e,t,i){const s=t?.actor,n=t?.actor?.id,l=t?.token?.id,o=i.id??i._id;let a=i?.name??i?.label;i?.system?.recharge&&!i?.system?.recharge?.charged&&i?.system?.recharge?.value&&(a+=` (${this.i18n("DND5E.Recharge")})`);let c="";if(Object.hasOwn(i,"disabled")){c=`toggle${i.disabled?"":" active"}`}const r=[e,n,l,o].join(this.delimiter),d=this.getImage(i),m=this._getIcon(i?.system?.activation?.type),u=this._getItemInfo(s,i);return{id:o,name:a,encodedValue:r,cssClass:c,img:d,icon:m,info1:u.info1,info2:u.info2,info3:u.info3,selected:!0}}_getItemInfo(e,t){return{info1:this._getQuantityData(t)??"",info2:this._getUsesData(t)??"",info3:this._getConsumeData(t,e)??""}}_buildRests(e,t){const i=t?.actor,s=t?.actor?.id,n=t?.token?.id;if(!("multi"===s?this._getActors():[i]).every((e=>"character"===e.type)))return;const l="utility",o={shortRest:{name:this.i18n("DND5E.ShortRest")},longRest:{name:this.i18n("DND5E.LongRest")}},a=Object.entries(o).map((e=>{const t=e[0],i=e[1].name,o=[l,s,n,t].join(this.delimiter);return{id:t,name:i,encodedValue:o,selected:!0}}));this.addActionsToActionList(e,a,"rests")}_buildSkills(e,t){const i=t?.actor,s=t?.actor?.id,n=t?.token?.id,l="skill",o=getSetting("abbreviateSkills"),c="multi"===s?game.dnd5e.config.skills:i.system.skills;if(0===c.length)return;const r=Object.entries(c).map((e=>{try{const t=e[0],i=t.charAt(0).toUpperCase()+t.slice(1),a=o?i:game.dnd5e.config.skills[t].label,r=[l,s,n,t].join(this.delimiter);return{id:t,name:a,encodedValue:r,icon:this._getProficiencyIcon(c[t].value)}}catch(t){return a.error(e),null}})).filter((e=>!!e));this.addActionsToActionList(e,r,"skills")}_buildSpells(e,t){const i=t?.actor;let s=i.items.filter((e=>"spell"===e.type));if(0===s.length)return;s=this._discardSlowItems(s),s=this._discardExpendedItems(s),s=this._discardNonPreparedSpells(i,s),s=this._sortSpellsByLevel(s);const n=Object.entries(i.system.spells).sort(((e,t)=>Intl.Collator().compare(t[0],e[0]))),l=n.find((e=>"pact"===e[0]));let o=!1;n.filter((e=>"maxLevel"!==e[0])).forEach((e=>{e[0].startsWith("spell")?(!o&&e[1].max>0&&e[1].value>0&&(o=!0),o||e[0]!=="spell"+l[1]?.level||l[1].max>0&&l[1].value>0&&(o=!0),e[1].slotsAvailable=o):(e[1]||(e[1]={}),e[1].slotsAvailable=!e[1].max||e[1].value>0)}));const a=n.findIndex((e=>"pact"===e[0]));if(!n[a][1].slotsAvailable){const e=n.findIndex((e=>e[0]==="spell"+l[1].level));n[a][1].slotsAvailable=n[e][1].slotsAvailable}const c=[...new Set(s.map((e=>{const t=e.system.preparation.mode,i=e.system.level;return!("pact"!==t&&"atwill"!==t&&"innate"!==t)?t:i})))].map((e=>e));for(const i of c){let l=null;switch(i){case 0:l="cantrips";break;case 1:l="1st-level-spells";break;case 2:l="2nd-level-spells";break;case 3:l="3rd-level-spells";break;case 4:l="4th-level-spells";break;case 5:l="5th-level-spells";break;case 6:l="6th-level-spells";break;case 7:l="7th-level-spells";break;case 8:l="8th-level-spells";break;case 9:l="9th-level-spells"}const o=i,a=!("pact"!==o&&"atwill"!==o&&"innate"!==o),c=n.find((e=>e[0]===`spell${o}`))?.[1],r=c?.value,d=c?.max,m=c?.slotsAvailable,u=getSetting("showUnchargedItems");if(d&&!m&&!u)continue;if(d>0){const t={};t.info1=`${r}/${d}`,this.addSubcategoryInfo(e,l,t)}const p=[];for(const e of s){if((a?e.system.preparation.mode:e.system.level)===o){const i=this._getAction("spell",t,e);getSetting("displaySpellInfo")&&this._addSpellInfo(e,i),p.push(i)}}this.addActionsToActionList(e,p,l)}}_sortSpellsByLevel(e){const t=Object.keys(e).map((t=>e[t]));return t.sort(((e,t)=>e.system.level===t.system.level?e.name.localeCompare(t.name):e.system.level-t.system.level)),t}_addSpellInfo(e,t){const i=e.system.components;t.info1="",t.info2="",t.info3="",i?.vocal&&(t.info1+=this.i18n("DND5E.ComponentVerbal").charAt(0).toUpperCase()),i?.somatic&&(t.info1+=this.i18n("DND5E.ComponentSomatic").charAt(0).toUpperCase()),i?.material&&(t.info1+=this.i18n("DND5E.ComponentMaterial").charAt(0).toUpperCase()),i?.concentration&&(t.info2+=this.i18n("DND5E.Concentration").charAt(0).toUpperCase()),i?.ritual&&(t.info3+=this.i18n("DND5E.Ritual").charAt(0).toUpperCase())}_buildUtility(e,t){const i=t?.actor,s=t?.actor?.id,n=t?.token?.id,l="multi"===s?this._getActors():[i];if(!l.every((e=>"character"===e.type)))return;const o="utility",a={deathSave:{name:this.i18n("DND5E.DeathSave")},inspiration:{name:this.i18n("DND5E.Inspiration")}};("multi"===s||i.system.attributes.hp.value>0)&&delete a.deathSave;const c=Object.entries(a).map((e=>{const t=e[0],i=e[1].name,a=[o,s,n,t].join(this.delimiter);let c="";if("inspiration"===e[0]){const e=l.every((e=>e.system.attributes?.inspiration))?" active":"";c=`toggle${e}`}return{id:t,name:i,encodedValue:a,cssClass:c,selected:!0}}));this.addActionsToActionList(e,c,"utility")}_getActors(){const e=["character","npc"],t=canvas.tokens.controlled.map((e=>e.actor));if(t.every((t=>e.includes(t.type))))return t}_getQuantityData(e){const t=e?.system?.quantity;return t>1?t:""}_getUsesData(e){let t="";const i=e?.system?.uses;return i?(t=0===i.value&&i.max?"0":i.value,i.max>0&&(t+=`/${i.max}`),t):t}_getConsumeData(e,t){let i="";const s=e?.system?.consume?.type;if(s&&""!==s){const n=e.system.consume.target,l=n.substr(0,n.lastIndexOf("."));if("attribute"===s){const e=getProperty(t,`system.${l}`);e&&(i=e.value??0,e.max&&(i+=`/${e.max}`))}if("charges"===s){const s=e.system.consume.target,n=t.items.get(s)?.system.uses;n?.value&&(i=n.value,n.max&&(i+=`/${n.max}`))}if("attribute"!==s&&"charges"!==s){const s=e.system.consume.target,n=t.items.get(s)?.system.quantity;n&&(i=n)}}return i}_discardSlowItems(e){let t;return getSetting("showSlowActions")||(t=e.filter((e=>!e.system.activation||!("minute"===e.system.activation.type||"hour"===e.system.activation.type||"day"===e.system.activation.type)))),t||e}_discardNonPreparedSpells(e,t){if("character"!==e.type&&getSetting("showUnequippedItems"))return;const i=Object.keys(game.dnd5e.config.spellPreparationModes).filter((e=>"prepared"!==e));let s=t;return s=getSetting("showUnpreparedSpells")?t.filter((e=>e.system.preparation.prepared||i.includes(e.system.preparation.mode)||0===e.system.level)):t.filter((e=>e.system.preparation.prepared)),s}_discardExpendedItems(e){return getSetting("showUnchargedItems")?e:e.filter((e=>{const t=e.system.uses;return!t||!(t.max>0&&!t.value)}))}_getProficiencyIcon(e){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[e]}_getIcon(e){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',day:'<i class="fas fa-hourglass-end"></i>',hour:'<i class="fas fa-hourglass-half"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>'}[e]}}class RollHandler extends l{async doHandleActionEvent(e,t){const i=t.split("|");4!==i.length&&super.throwInvalidValueErr();const s=i[0],n=i[1],l=i[2],o=i[3];if("multi"===l&&"toggleCombat"!==o)for(const t of canvas.tokens.controlled){const i=t.actor?.id,n=t.id;await this._handleMacros(e,s,i,n,o)}else await this._handleMacros(e,s,n,l,o)}async _handleMacros(e,t,i,s,n){switch(t){case"ability":this._rollAbility(e,i,s,n);break;case"abilityCheck":this._rollAbilityTest(e,i,s,n);break;case"abilitySave":this._rollAbilitySave(e,i,s,n);break;case"condition":if(!s)return;await this._toggleCondition(e,s,n);break;case"effect":await this._toggleEffect(e,i,s,n);break;case"feature":case"item":case"spell":case"weapon":this.isRenderItem()?this.doRenderItem(i,s,n):this._useItem(e,i,s,n);break;case"magicItem":this._rollMagicItem(e,i,s,n);break;case"skill":this._rollSkill(e,i,s,n);break;case"utility":await this._performUtilityMacro(e,i,s,n)}}_rollAbility(e,t,i,s){super.getActor(t,i).rollAbility(s,{event:e})}_rollAbilitySave(e,t,i,s){super.getActor(t,i).rollAbilitySave(s,{event:e})}_rollAbilityTest(e,t,i,s){super.getActor(t,i).rollAbilityTest(s,{event:e})}_rollMagicItem(e,t,i,s){const n=super.getActor(t,i),l=s.split(">"),o=l[0],a=l[1];MagicItems.actor(n.id).roll(o,a),Hooks.callAll("forceUpdateTokenActionHud")}_rollSkill(e,t,i,s){super.getActor(t,i).rollSkill(s,{event:e})}_useItem(e,t,i,s){const n=super.getActor(t,i),l=super.getItem(n,s);if(!this._needsRecharge(l))return l.use({event:e});l.rollRecharge()}_needsRecharge(e){return e.system.recharge&&!e.system.recharge.charged&&e.system.recharge.value}async _performUtilityMacro(e,t,i,s){const n=super.getActor(t,i),l=super.getToken(i);switch(s){case"deathSave":n.rollDeathSave({event:e});break;case"endTurn":if(!l)break;game.combat?.current?.tokenId===i&&await(game.combat?.nextTurn());break;case"initiative":await this._rollInitiative(t);break;case"inspiration":{const e=!n.system.attributes.inspiration;n.update({"data.attributes.inspiration":e});break}case"longRest":n.longRest();break;case"shortRest":n.shortRest();break;case"toggleCombat":if(0===canvas.tokens.controlled.length)break;await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud");break;case"toggleVisibility":if(!l)break;l.toggleVisibility(),Hooks.callAll("forceUpdateTokenActionHud")}}async _rollInitiative(e,t){const i=super.getActor(e,t);await i.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHud")}async _toggleCondition(e,t,i,s=null){const n=super.getToken(t),l=this.isRightClick(e);if(game.dfreds&&s?.flags?.isConvenient){const e=s.label;game.dfreds.effectInterface._toggleEffect(e)}else{const e=this.findCondition(i);if(!e)return;l?await n.toggleEffect(e,{overlay:!0}):await n.toggleEffect(e)}Hooks.callAll("forceUpdateTokenActionHud")}findCondition(e){return CONFIG.statusEffects.find((t=>t.id===e))}async _toggleEffect(e,t,i,s){const n=super.getActor(t,i),l=("find"in n.effects.entries?n.effects.entries:n.effects).find((e=>e.id===s));if(!l)return;this.isRightClick(e)?await l.delete():await l.update({disabled:!l.disabled}),Hooks.callAll("forceUpdateTokenActionHud")}}class RollHandlerObsidian extends RollHandler{_rollAbilityTest(e,t,i,s){const n=super.getActor(t,i);OBSIDIAN.Items.roll(n,{roll:"abl",abl:s})}_rollAbilitySave(e,t,i,s){const n=super.getActor(t,i);OBSIDIAN.Items.roll(n,{roll:"save",save:s})}_rollSkill(e,t,i,s){const n=super.getActor(t,i);OBSIDIAN.Items.roll(n,{roll:"skl",skl:s})}_useItem(e,t,i,s){const n=super.getActor(t,i);OBSIDIAN.Items.roll(n,{roll:"item",id:s})}}class MagicItemActionListExtender extends i{extendActionList(e,t){const i=t?.actor?.id,s=t?.token?.id;if(!i)return;const n=MagicItems.actor(i);if(!n)return;const l=n.items??[];if(0===l.length)return;const o=[];l.forEach((e=>{if(e.attuned&&!this._isItemAttuned(e))return;if(e.equipped&&!this._isItemEquipped(e))return;const t=`magic-items_${e.id}`,n=e.name,l=this.initializeEmptySubcategory(t,t,n,"system");l.info1=`${e.uses}/${e.charges}`;const a=e.ownedEntries.map((t=>{const n=t.item,l=n.id,o=n.name,a=["magicItem",i,s,`${e.id}>${l}`].join("|"),c=this.getImage(n),r=n.consumption;let d="";return n.baseLevel&&(d=`${this.i18n("DND5E.AbbreviationLevel")} ${n.baseLevel}`),{id:l,name:o,encodedValue:a,img:c,info1:r,info2:d}}));this.addToSubcategoryList(o,t,l,a)})),this.addSubcategoriesToActionList(e,o,"magic-items")}_isItemEquipped(e){return e.item.system.equipped}_isItemAttuned(e){const t=e.item.system;if(t.attunement){const e=CONFIG.DND5E.attunementTypes?.ATTUNED??2;return t.attunement===e}return!!t.attuned&&t.attuned}}function register(e){const t="token-action-hud-dnd5e";game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showSlowActions",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showSlowActions.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showSlowActions.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"displaySpellInfo",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.displaySpellInfo.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.displaySpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showUnchargedItems",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnchargedItems.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnchargedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showUnequippedItems",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnequippedItems.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnequippedItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showUnpreparedSpells",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnpreparedSpells.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnpreparedSpells.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showItemsWithoutActivationCosts",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showItemsWithoutActivationCosts.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showItemsWithoutActivationCosts.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}class SystemManager extends o{doGetCategoryManager(e){return new s(e)}doGetActionHandler(e,t){const i=new ActionHandler(e,t);return o.isModuleActive("magicitems")&&i.addFurtherActionHandler(new MagicItemActionListExtender),i}getAvailableRollHandlers(){let e="Core D&D5e";o.isModuleActive("midi-qol")&&(e+=` [supports ${o.getModuleTitle("midi-qol")}]`);const t={core:e};return o.addHandler(t,"obsidian"),t}doGetRollHandler(e){let t;if("obsidian"===e)t=new RollHandlerObsidian;else t=new RollHandler;return t}doRegisterSettings(e){register(e)}async doRegisterDefaultFlags(){const e={default:{categories:{inventory:{id:"inventory",title:this.i18n("DND5E.Inventory"),subcategories:{inventory_weapons:{id:"weapons",title:this.i18n("DND5E.ItemTypeWeaponPl"),type:"system"},inventory_equipment:{id:"equipment",title:this.i18n("DND5E.ItemTypeEquipmentPl"),type:"system"},inventory_consumables:{id:"consumables",title:this.i18n("DND5E.ItemTypeConsumablePl"),type:"system"},inventory_tools:{id:"tools",title:this.i18n("DND5E.ItemTypeToolPl"),type:"system"},inventory_containers:{id:"containers",title:this.i18n("DND5E.ItemTypeContainerPl"),type:"system"},inventory_loot:{id:"loot",title:this.i18n("DND5E.ItemTypeLootPl"),type:"system"}}},features:{id:"features",title:this.i18n("DND5E.Features"),subcategories:{"features_active-features":{id:"active-features",title:this.i18n("tokenActionHud.dnd5e.activeFeatures"),type:"system"},"features_passive-features":{id:"passive-features",title:this.i18n("tokenActionHud.dnd5e.passiveFeatures"),type:"system"}}},spells:{id:"spells",title:this.i18n("DND5E.ItemTypeSpellPl"),subcategories:{spells_cantrips:{id:"cantrips",title:this.i18n("tokenActionHud.dnd5e.cantrips"),type:"system"},"spells_1st-level-spells":{id:"1st-level-spells",title:this.i18n("tokenActionHud.dnd5e.1stLevelSpells"),type:"system"},"spells_2nd-level-spells":{id:"2nd-level-spells",title:this.i18n("tokenActionHud.dnd5e.2ndLevelSpells"),type:"system"},"spells_3rd-level-spells":{id:"3rd-level-spells",title:this.i18n("tokenActionHud.dnd5e.3rdLevelSpells"),type:"system"},"spells_4th-level-spells":{id:"4th-level-spells",title:this.i18n("tokenActionHud.dnd5e.4thLevelSpells"),type:"system"},"spells_5th-level-spells":{id:"5th-level-spells",title:this.i18n("tokenActionHud.dnd5e.5thLevelSpells"),type:"system"},"spells_6th-level-spells":{id:"6th-level-spells",title:this.i18n("tokenActionHud.dnd5e.6thLevelSpells"),type:"system"},"spells_7th-level-spells":{id:"7th-level-spells",title:this.i18n("tokenActionHud.dnd5e.7thLevelSpells"),type:"system"},"spells_8th-level-spells":{id:"8th-level-spells",title:this.i18n("tokenActionHud.dnd5e.8thLevelSpells"),type:"system"},"spells_9th-level-spells":{id:"9th-level-spells",title:this.i18n("tokenActionHud.dnd5e.9thLevelSpells"),type:"system"}}},attributes:{id:"attributes",title:this.i18n("DND5E.Attributes"),subcategories:{attributes_abilities:{id:"abilities",title:this.i18n("tokenActionHud.dnd5e.abilities"),type:"system"},attributes_skills:{id:"skills",title:this.i18n("tokenActionHud.dnd5e.skills"),type:"system"}}},effects:{id:"effects",title:this.i18n("DND5E.Effects"),subcategories:{"effects_temporary-effects":{id:"temporary-effects",title:this.i18n("DND5E.EffectTemporary"),type:"system"},"effects_passive-effects":{id:"passive-effects",title:this.i18n("DND5E.EffectPassive"),type:"system"}}},conditions:{id:"conditions",title:this.i18n("tokenActionHud.dnd5e.conditions"),subcategories:{conditions_conditions:{id:"conditions",title:this.i18n("tokenActionHud.dnd5e.conditions"),type:"system"}}},utility:{id:"utility",title:this.i18n("tokenActionHud.utility"),subcategories:{utility_combat:{id:"combat",title:this.i18n("tokenActionHud.combat"),type:"system"},utility_token:{id:"token",title:this.i18n("tokenActionHud.token"),type:"system"},utility_rests:{id:"rests",title:this.i18n("tokenActionHud.dnd5e.rests"),type:"system"},utility_utility:{id:"utility",title:this.i18n("tokenActionHud.utility"),type:"system"}}}},subcategories:[{id:"abilities",title:this.i18n("tokenActionHud.dnd5e.abilities"),type:"system"},{id:"actions",title:this.i18n("DND5E.ActionPl"),type:"system"},{id:"bonus-actions",title:this.i18n("tokenActionHud.dnd5e.bonusActions"),type:"system"},{id:"lair-actions",title:this.i18n("tokenActionHud.dnd5e.lairActions"),type:"system"},{id:"legendary-actions",title:this.i18n("tokenActionHud.dnd5e.legendaryActions"),type:"system"},{id:"checks",title:this.i18n("tokenActionHud.dnd5e.checks"),type:"system"},{id:"combat",title:this.i18n("tokenActionHud.combat"),type:"system"},{id:"conditions",title:this.i18n("tokenActionHud.dnd5e.conditions"),type:"system"},{id:"consumables",title:this.i18n("DND5E.ItemTypeConsumablePl"),type:"system"},{id:"containers",title:this.i18n("DND5E.ItemTypeContainerPl"),type:"system"},{id:"crew-actions",title:this.i18n("tokenActionHud.dnd5e.crewActions"),type:"system"},{id:"temporary-effects",title:this.i18n("DND5E.EffectTemporary"),type:"system"},{id:"passive-effects",title:this.i18n("DND5E.EffectPassive"),type:"system"},{id:"equipment",title:this.i18n("DND5E.ItemTypeEquipmentPl"),type:"system"},{id:"equipped",title:this.i18n("DND5E.Equipped"),type:"system"},{id:"active-features",title:this.i18n("tokenActionHud.dnd5e.activeFeatures"),type:"system"},{id:"passive-features",title:this.i18n("tokenActionHud.dnd5e.passiveFeatures"),type:"system"},{id:"loot",title:this.i18n("DND5E.ItemTypeLootPl"),type:"system"},{id:"other-actions",title:this.i18n("tokenActionHud.dnd5e.otherActions"),type:"system"},{id:"reactions",title:this.i18n("DND5E.ReactionPl"),type:"system"},{id:"rests",title:this.i18n("tokenActionHud.dnd5e.rests"),type:"system"},{id:"saves",title:this.i18n("DND5E.ClassSaves"),type:"system"},{id:"skills",title:this.i18n("tokenActionHud.dnd5e.skills"),type:"system"},{id:"cantrips",title:this.i18n("tokenActionHud.dnd5e.cantrips"),type:"system"},{id:"1st-level-spells",title:this.i18n("tokenActionHud.dnd5e.1stLevelSpells"),type:"system"},{id:"2nd-level-spells",title:this.i18n("tokenActionHud.dnd5e.2ndLevelSpells"),type:"system"},{id:"3rd-level-spells",title:this.i18n("tokenActionHud.dnd5e.3rdLevelSpells"),type:"system"},{id:"4th-level-spells",title:this.i18n("tokenActionHud.dnd5e.4thLevelSpells"),type:"system"},{id:"5th-level-spells",title:this.i18n("tokenActionHud.dnd5e.5thLevelSpells"),type:"system"},{id:"6th-level-spells",title:this.i18n("tokenActionHud.dnd5e.6thLevelSpells"),type:"system"},{id:"7th-level-spells",title:this.i18n("tokenActionHud.dnd5e.7thLevelSpells"),type:"system"},{id:"8th-level-spells",title:this.i18n("tokenActionHud.dnd5e.8thLevelSpells"),type:"system"},{id:"9th-level-spells",title:this.i18n("tokenActionHud.dnd5e.9thLevelSpells"),type:"system"},{id:"token",title:this.i18n("tokenActionHud.token"),type:"system"},{id:"tools",title:this.i18n("DND5E.ItemTypeToolPl"),type:"system"},{id:"weapons",title:this.i18n("DND5E.ItemTypeWeaponPl"),type:"system"},{id:"unequipped",title:this.i18n("DND5E.Unequipped"),type:"system"},{id:"utility",title:this.i18n("tokenActionHud.utility"),type:"system"}]}};game.modules.get("magicitems")?.active&&(e.default.subcategories.push({id:"magic-items",title:this.i18n("tokenActionHud.dnd5e.magicItems"),type:"system"}),e.default.subcategories.sort(((e,t)=>e.id.localeCompare(t.id)))),await game.user.update({flags:{"token-action-hud-core":e}})}}export{ActionHandler,t as CoreActionHandler,i as CoreActionListExtender,s as CoreCategoryManager,n as CorePreRollHandler,l as CoreRollHandler,o as CoreSystemManager,a as Logger,MagicItemActionListExtender,RollHandler,RollHandlerObsidian,SystemManager,getSetting,register,setSetting};
